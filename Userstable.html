<!DOCTYPE html>
<html lang="en">

<head>
  <link rel="stylesheet" href="booktablestyle.css">
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
    crossorigin="anonymous"></script>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Users</title>
</head>

<body>
  <div class="wholehead" id="head">
    <div class="header" id="myHeader">
      <h2>Working Talent

      </h2>
    </div>


    <div id="navbarwt" class="navbarwt">

      <div class="dropdownwt">
        <button class="dropbtnwt" onclick="location.href='showbooks.html'">
          Home
        </button>
      </div>

      <div class="dropdownwt">
        <button class="dropbtnwt">
          My account

        </button>
        <div class="dropdown-contentwt">
          <a href="userportal.html">User Portal</a>
          <a href="accountSettings.html">Account Settings</a>
        </div>
      </div>
      <div class="dropdownwt" id="adminmenu">
        <button class="dropbtnwt">
          Admin

        </button>
        <div class="dropdown-contentwt">
          <a href="adminportal.html">Admin portal</a>
          <a href="booktable.html">Book Table</a>
          <a href="bookcopy.html">Copy Table</a>
          <a href="userstable.html"> User Table</a>
          <a href="reservation.html"> Reservation Table</a>
          <a href="borrowedcopy.html"> Borrowedcopy Table</a>
          <a href="addpage.html">Add Books/Users</a>
        </div>
      </div>
      <form align="right" name="form1" method="post" onclick="deleteTokenDataBase()" action = "inlogapage.html">
        <label class="logoutLblPos">
          <input name="submit2" type="submit" id="submit2" value="Log out" class="btn btn-success" />
        </label>
      </form>
    </div>
  </div>


  <div class="search-container">
    <div class="form-group">
      <input type="text" class="form-control" placeholder="Search" id="searchbox">
    </div>
  </div>

  <div id="notfound">

  </div>

  <div class="container">
    <table class="table styled-table">
      <thead>
        <tr>
          <th>User ID</th>
          <th style="display: none">Active</th>
          <th>Employee</th>
          <th>Email</th>
          <th style="display: none">Password</th>
          <th style="display: none">Username</th>
          <th>Admin</th>
          <th>Set Admin</th>
          <th>Assign Book</th>
          <th>Deactivate User</th>
        </tr>
      </thead>
      <tbody id="users-data">


      </tbody>
    </table>
  </div>



  <!-- Modal -->
  <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" style="max-width: fit-content;">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Assign Book </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="modal-table">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>Book Title</th>
              </tr>
            </thead>
            <tbody id="allBooksTable">


            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>


  <div class="modal fade" id="borrowedCopyModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" style="max-width:fit-content;">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Lending History</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="borrowed-modal-table">
        </div>
      </div>
    </div>
  </div>

  <footer class="w3-container w3-teal">
    <br>
    <br>
    <h4>Working Talent Dev</h4>
    <br>
    <br>
  </footer>
</body>


<script>

  document.body.onkeydown = function (e) {
    if (e.keyCode == 13)
      search();
  };

  function search() {
    let keyword = document.getElementById("searchbox").value;
    console.log(keyword);

    fetch(`http://localhost:8080/users/search/${keyword}`, {
      headers: {
        "Content-Type": "application/json",
        Authorization: localStorage.getItem("token"),
      }
    })
      .then((res) => res.json())
      .then((data) => {

        if (data.length == 0) {
          console.log("I am here")
          document.getElementById("notfound").innerHTML = "<br><br><br><h1 style='text-align: center;'>No users found</h1>"
          document.getElementById("users-data").innerHTML = "";
        }
        else {

          let usersHtml = '';
          data.forEach(user => {

            document.getElementById("notfound").innerHTML = "";

            usersHtml += `
  <tr onclick = "showBorrowedCopiesByUser(${user.id})">
      <td data-bs-toggle="modal" data-bs-target="#borrowedCopyModal">${user.id}</td>
      <td style="display: none">${user.active}</td>

      <td data-bs-toggle="modal" data-bs-target="#borrowedCopyModal" >${user.name}</td>
      <td data-bs-toggle="modal" data-bs-target="#borrowedCopyModal">${user.email}</td>
      <td style="display: none">${user.password}</td>
      <td style="display: none">${user.username}</td>
      `
            if (user.admin) {
              usersHtml += `<td class = "checkmark"><span >&#10003;</span></td>`
            }
            else {
              usersHtml += `<td></td>`
            }
            if (user.active) {
              usersHtml += `<td>
                    <button class="button-4" type="button" onclick = "confirmAdmin(${user.id},${user.admin})">
                              Set admin
                            </button>
                          </td>
                          <td>
                            <button class="button-4" type="button" onclick = "showAllBooks(${user.id})" data-bs-toggle="modal" data-bs-target="#exampleModal">
                              Assign bookcopy
                            </button>
                            </td>
                            <td>
                        <button class="button-4" type="button" onclick = "confirmDeactivation(${user.id})">
                          Deactivate user
                        </button>
                       
                      </td>`
            }
            else {
              usersHtml +=
                `<td></td>
<td></td>
<td></td>`
            }
            usersHtml += `</tr>`

            document.getElementById('users-data').innerHTML = usersHtml

          })
          // .catch(e => {alert(e)});
          // // if (res.status == 403) {
          // //   window.location.href = 'errorpage.html'
          // // }
        }
      })
  }

  /**
 * calls the backend to delete the token in the database
 */
 function deleteTokenDataBase(){

fetch('http://localhost:8080/user/logout/empty/token', {    
    headers: {
            "Content-Type": "application/json",
            Authorization: localStorage.getItem("token"),
        }
    })
    .then(res => res.json())
    .then(data => {
        console.log('Token is empty in the database');
        
       
    })
    .then(localStorage.clear())
   
}

  //Checks if admin or not
  let hasAdminRights = localStorage.getItem('admin') == 1;
  if (!hasAdminRights) {
    document.getElementById('adminmenu').style.display = 'none';
  }
  /**
   * Comment added by Omur
   * This function shows the users in a table.
   * When this function is called, it auto-generates a table with:
   * user ID, Active?, Admin?, name, email, password, username
   * and a button to assign bookcopy to the user.
   */
  function showUsers() {
    fetch('http://localhost:8080/users', {
      method: "GET",
      headers: {
        "Content-Type": "application/json",
        "Authorization": localStorage.getItem('token')
      }
    })
      .then(res => {
        return res.json()
        // if (res.ok){
        //   return res.json()
        // }
        // throw new Error('Access denied')
      })
      .then(data => {

        let usersHtml = '';
        data.forEach(user => {



          usersHtml += `
                <tr onclick = "showBorrowedCopiesByUser(${user.id})">
                    <td data-bs-toggle="modal" data-bs-target="#borrowedCopyModal">${user.id}</td>
                    <td style="display: none">${user.active}</td>

                    <td data-bs-toggle="modal" data-bs-target="#borrowedCopyModal" >${user.name}</td>
                    <td data-bs-toggle="modal" data-bs-target="#borrowedCopyModal">${user.email}</td>
                    <td style="display: none">${user.password}</td>
                    <td style="display: none">${user.username}</td>
                    `
          if (user.admin) {
            usersHtml += `<td class = "checkmark"><span >&#10003;</span></td>`
          }
          else {
            usersHtml += `<td></td>`
          }
          if (user.active) {
            usersHtml += `<td>
                                  <button class="button-4" type="button" onclick = "confirmAdmin(${user.id},${user.admin})">
                                            Set admin
                                          </button>
                                        </td>
                                        <td>
                                          <button class="button-4" type="button" onclick = "showAllBooks(${user.id})" data-bs-toggle="modal" data-bs-target="#exampleModal">
                                            Assign bookcopy
                                          </button>
                                          </td>
                                          <td>
                                      <button class="button-4" type="button" onclick = "confirmDeactivation(${user.id})">
                                        Deactivate user
                                      </button>
                                     
                                    </td>`
          }
          else {
            usersHtml +=
              `<td></td>
            <td></td>
            <td></td>`
          }
          usersHtml += `</tr>`

          document.getElementById('users-data').innerHTML = usersHtml

        })
        // .catch(e => {alert(e)});
        // // if (res.status == 403) {
        // //   window.location.href = 'errorpage.html'
        // // }
      })
  }

  function viewBookIdPrompt() {
    let text;
    let amount = prompt("Please enter the bookid:", "0");
    if (amount == null || amount == "") {
      text = "User cancelled the prompt.";
    } else {
      return amount
    }

  }
  function showAllBooks(userId) {
    fetch('http://localhost:8080/books', {
      headers: {
        "Content-Type": "application/json",
        Authorization: localStorage.getItem("token"),
      }
    })
      .then(res => res.json())
      .then(data => {

        let booksHtml = `<table class = "table table-striped">
                              <thead>
                                  <tr>
                                      <th style="display:none">Book Id</th>
                                      <th>Book Title</th>
                                      <th>Author</th>
                                      <th>Show available copies</th>
                                  </tr>
                              </thead>
                              <tbody>`;
        data.forEach(book => {
          booksHtml += `
                                      <tr > 
                                        <td style="display:none">${book.id}</td> 
                                          <td>${book.title}</td> 
                                              <td>${book.author}</td>
                                              <td>
                                                <button class="button-4" onclick = "viewCopies(${book.id},${userId})" data-bs-target="#exampleModal">
                                                  Show available copies  
                                                </button>
                                                </td>
                                      </tr>`;

        });
        booksHtml += `</tbody>
                                    </table>`
        document.getElementById("modal-table").innerHTML = booksHtml;
        //console.log(this.responseText);
      })
  }


  function viewCopies(bookId, userId) {
    fetch(`http://localhost:8080/book/${bookId}/availablecopies`, {
      method: "GET",
      headers: {
        "Content-Type": "application/json",
        "Authorization": localStorage.getItem('token')
      }
    })
      .then((res) => res.json())
      .then(data => {
        let copiesHtml = `<table class = "table table-striped">
                              <thead>
                                  <tr>
                                      <th style="display:none">BookCopy Id</th>
                                      <th>Working Talent Id</th>
                                      <th>Title</th>
                                      <th>Assign</th>
                                  </tr>
                              </thead>
                              <tbody>`

        data.forEach(copy => {
          copiesHtml += `
                <tr >
                    <td style="display:none">${copy.id}</td>
                    <td>${copy.workingTalentId}</td>
                    <td>${copy.bookTitle}</td>
                    <td> <button class = button onclick = "chooseCopy(${copy.id},${userId})" data-bs-dismiss="modal" data-bs-target="#ExampleModal">
                            Assign copy
                          </button></td> 
                </tr>
                `
        })
        copiesHtml += `</tbody>
                          </table>`
        document.getElementById("modal-table").innerHTML = copiesHtml;
      })
  }

  function chooseCopy(copyId, userId) {

    let newBorrowedCopy = {
      bookCopyId: Number(copyId),
      userId: Number(userId),

    };
    fetch(`http://localhost:8080/user/${userId}/assign`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify(newBorrowedCopy),
    })
      .then((res) => {
        showUsers();

      })
      .catch((error) => {
        alert("Er is iets fouts gegaan");
      });



  }

  /**
  * Comment added by Omur
  * pop-up with x
  */
  function addBookCopies2(x) {

    alert(x);
  }

  /**
   * Comment added by Omur
   * This function makes it possible to update an User.
   * The admin can change the users name, email, username, password,
   * and het can choose to set the user on active or make him an admin.
   */

  function confirmAdmin(userId, admin) {
    if (confirm("Change admin status?") == true) {
      isAdmin = !admin;
      setAdmin(userId, isAdmin)
    } else {

    }

  }

  function setAdmin(userId, isAdmin) {
    //formulier uitlezen
    admin = isAdmin;


    let newUser = {
      admin: admin
    }

    // Fetch call
    fetch(`http://localhost:8080/user/${userId}/setadmin`, {
      method: "PUT",
      headers: {
        "Content-Type": "application/json",
        "Authorization": localStorage.getItem('token')
      },
      body: JSON.stringify(newUser),
    })
      .then((res) => {
        showUsers();
      })
      .catch((error) => {
        alert("Er is iets fouts gegaan");
      });
  }
  // Deactivate user 
  // anonimiseerd de gegeven van de gebruiker
  function deactivateUser(userId) {


    // Fetch call
    fetch(`http://localhost:8080/user/${userId}/deactivate`, {
      method: "PUT",
      headers: {
        "Content-Type": "application/json",
        "Authorization": localStorage.getItem('token')
      },
      // body: JSON.stringify(newUser),
    })
      .then((res) => res.json())
      .then(dto => {
        if (dto.success) {
          showUsers();
        }
        else {
          alert(dto.validationMessages[0]);
        }
      })
      .catch((error) => {
        console.error(error);
        alert("Er is iets fouts gegaan");
      });
  }

  function confirmDeactivation(userId) {
    if (confirm("Are you sure you want to deactivate this user?") == true) {
      deactivateUser(userId)
    } else {

    }

  }



  function updateUser() {
    // Dit kan naar de create userpage.
    let idInput = document.getElementById("id").value;
    let nameInput = document.getElementById("name").value;
    let emailInput = document.getElementById("email").value;
    let usernameInput = document.getElementById("username").value;
    let passwordInput = document.getElementById("password").value;
    let isActiveInput = document.getElementById("isactive").checked;
    let isAdminInput = document.getElementById("isadmin").checked;

    // Javascript object
    let newUser = {
      name: nameInput,
      email: emailInput,
      username: usernameInput,
      password: passwordInput,
      admin: isAdminInput,
      active: isActiveInput,
    };
    // Fetch call
    fetch(`http://localhost:8080/user/update/${idInput}`, {
      method: "PUT",
      headers: {
        "Content-Type": "application/json",
        "Authorization": localStorage.getItem('token')
      },
      body: JSON.stringify(newUser),
    })
      .then((res) => {
        showUsers();
      })
      .catch((error) => {
        alert("Er is iets fouts gegaan");
      });
  }

  /**
   * Comment added by Omur
   * This function adds an User.
   * The admin can add an user with this function.
   */

  function addUser() {
    //formulier uitlezen
    let nameInput = document.getElementById("name").value;
    let emailInput = document.getElementById("email").value;
    let usernameInput = document.getElementById("username").value;
    let passwordInput = document.getElementById("password").value;
    let isActiveInput = document.getElementById("isactive").checked;
    let isAdminInput = document.getElementById("isadmin").checked;

    // Javascript object
    let newUser = {
      name: nameInput,
      email: emailInput,
      username: usernameInput,
      password: passwordInput,
      admin: isAdminInput,
      active: isActiveInput,
    };

    // Fetch call
    fetch('http://localhost:8080/user/save', {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": localStorage.getItem('token')
      },
      body: JSON.stringify(newUser),
    })
      .then((res) => {
        showUsers();

      })
      .catch((error) => {
        alert("Er is iets fouts gegaan");
      });

  }

  function showBorrowedCopiesByUser(userid) {
    fetch(`http://localhost:8080/user/${userid}/borrowedcopies`, {
      headers: {
        "Content-Type": "application/json",
        "Authorization": localStorage.getItem('token')
      },
    })
      .then(res => res.json())
      .then(data => {

        let borrowedCopiesHtml = `<table class="table table-striped">
              <thead>
                <tr>
                  <th>Working Talent Id</th>
                  <th>Book Title</th>
                  <th>Start Date </th>
                  <th>End Date</th>
                </tr>
              </thead>
              <tbody>`;
        data.forEach(borrowedcopy => {



          borrowedCopiesHtml += `
                                      <tr> 
                                        <td>${borrowedcopy.wtId}</td> 
                                        <td>${borrowedcopy.bookTitle}</td>
                                        <td>${borrowedcopy.startDate}     </td>`
          if (borrowedcopy.endDate == null) {
            borrowedCopiesHtml += `<td>---</td>`
          }
          else {
            borrowedCopiesHtml += `<td>${borrowedcopy.endDate}</td>`
          }
          borrowedCopiesHtml += `</tr>`;

        });
        borrowedCopiesHtml += ` </tbody>
                     </table>`;
        document.getElementById("borrowed-modal-table").innerHTML = borrowedCopiesHtml;
        //console.log(this.responseText);
      })
  }

  window.onscroll = function () { myFunction2() };

  var head = document.getElementById("navbarwt");
  var sticky = head.offsetTop;

  function myFunction2() {
    if (window.pageYOffset > sticky) {
      head.classList.add("sticky");
    } else {
      head.classList.remove("sticky");
    }

  }
  showUsers();

</script>
<style>
  .switch {
    position: relative;
    display: inline-block;
    width: 60px;
    height: 34px;
  }

  /* Hide default HTML checkbox */
  .switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }

  /* The slider */
  .slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    -webkit-transition: .4s;
    transition: .4s;
  }

  .slider:before {
    position: absolute;
    content: "";
    height: 26px;
    width: 26px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    -webkit-transition: .4s;
    transition: .4s;
  }

  input:checked+.slider {
    background-color: #2196F3;
  }

  input:focus+.slider {
    box-shadow: 0 0 1px #2196F3;
  }

  input:checked+.slider:before {
    -webkit-transform: translateX(26px);
    -ms-transform: translateX(26px);
    transform: translateX(26px);
  }

  /* Rounded sliders */
  .slider.round {
    border-radius: 34px;
  }

  .slider.round:before {
    border-radius: 50%;
  }

  tr:hover {
    background-color: #ffff99;
  }

  .styled-table tbody tr:nth-of-type(even):hover {
    background-color: #ffff99;
  }

  hr {
    width: 60%;
    margin: 0 auto;
  }

  .search-container {
    padding: 0 200px 0 200px;
    text-align: center;
    margin: 10px 50px 10px 50px;
  }
</style>

</html>