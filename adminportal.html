<!DOCTYPE html>
<html lang="en">

<head>
  <link rel="stylesheet" href="booktablestyle.css">
  <link rel="stylesheet" href="switch.css">
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
    crossorigin="anonymous"></script>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>

<body>
  <header class="w3-container w3-teal">
    <h1>Working Talent</h1>

    <form align="right" name="form1" method="post" action="inlogapage.html">
      <label class="logoutLblPos">
        <input name="submit2" type="submit" id="submit2" value="log out" onclick="localStorage.clear()">
      </label>
    </form>
  </header>
  <div class="navbarwt">
    <div class="dropdownwt">
      <button class="dropbtnwt">User
        <i class="fa fa-caret-down"></i>
      </button>
      <div class="dropdown-contentwt">
        <a href="userportal.html">User Portal</a>
        <a href="showbooks.html">Books</a>
        <a href="accountSettings.html">Account Settings</a>
      </div>
    </div>
    <div class="dropdownwt">
      <button class="dropbtnwt">Admin
        <i class="fa fa-caret-down"></i>
      </button>
      <div class="dropdown-contentwt">
        <a href="adminportal.html">Admin portal</a>
        <a href="booktable.html">Book Table</a>
        <a href="bookcopy.html">Copy Table</a>
        <a href="userstable.html"> User Table</a>
        <a href="reservation.html"> Reservation Table</a>
        <a href="borrowedcopy.html"> Borrowedcopy Table</a>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal fade" id="reservationModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Modal title</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>Bookcopy ID</th>
                <th>Assign Copy</th>
              </tr>
            </thead>
            <tbody id="bookcopiesdata">
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>


  <div class="container">
    <h2>Available Books</h2>
    <button onclick=showBookContainer()>
      Available books
    </button>

  </div>
  <div id="BookDiv" class="containertable container">

    <table class="table styled-table">
      <thead>
        <tr>
          <th>Book ID</th>
          <th>Title</th>
          <th>Author</th>
          <th>Isbn</th>
          <th>Availability</th>
          <th>Make Reservation</th>
        </tr>
      </thead>
      <tbody id="allBooksTable">


      </tbody>
    </table>
  </div>

  <div class="container">
    <h2>Pending Reservations</h2>
    <button onclick=showResContainer()>
      Pending Reservations
    </button>
  </div>
  <div id="ResDiv" class="containertable container">
    <table class="table styled-table">
      <thead>
        <tr>
          <th>Reservation ID</th>
          <th>Book title</th>
          <th>Employee</th>
          <th>Approve</th>
          <th>Deny</th>
        </tr>
      </thead>

      <tbody id="reservations-data">

      </tbody>
    </table>
  </div>

  </div>
  <div class="container">
    <h2>Lending History</h2>
    <button onclick=showLendingContainer()>
      Available books
    </button>
  </div>
  <div id="LenDiv" class="containertable container">
    <table class="table styled-table">
      <thead>
        <tr>
          <th>Lending History ID</th>
          <th>Bookcopyid</th>
          <th>Startdate</th>
          <th>Enddate</th>
          <th>Userid</th>
          <th>Return book</th>
        </tr>
      </thead>
      <tbody id="borrowedcopytable">


      </tbody>
    </table>
  </div>

</body>
<script>
  /**
   * This function toggle the visibility of the container where the book table is located
   */
  function showBookContainer() {
    var x = document.getElementById("BookDiv");
    if (x.style.display === "block") {
      x.style.display = "none";
    } else {
      x.style.display = "block";
    }
  }

  /**
   * This function toggle the visibility of the container where the reservation table is located
   */
  function showResContainer() {
    var x = document.getElementById("ResDiv");
    if (x.style.display === "block") {
      x.style.display = "none";
    } else {
      x.style.display = "block";
    }
  }

  /**
   * This function toggle the visibility of the container where the Lending history table is located
   */

  function showLendingContainer() {
    var x = document.getElementById("LenDiv");
    if (x.style.display === "block") {
      x.style.display = "none";
    } else {
      x.style.display = "block";
    }
  }
  /**
  * This shows all books in the book repository and fills booktable with content.
 */
  function showAllBooks() {
    fetch('http://localhost:8080/books', {
      headers: {
        "Content-Type": "application/json",
        Authorization: localStorage.getItem("token"),
      }
    })
      .then(res => res.json())
      .then(data => {
        console.log('het is gelukt');

        console.log(data);

        let booksHtml = '';
        data.forEach(book => {
          booksHtml += `
                                      <tr > 
                                          <td >${book.id}</td>
                                          <td >${book.title}</td> 
                                              <td>${book.author}</td>
                                              <td>${book.isbn}</td>`
          if (book.available) {
            booksHtml += `        <td style= "color:green">In stock</td>`
          } else {
            booksHtml += `        <td style= "color:red">Unavailable at this moment</td>`
          }
          booksHtml += `            <td><button type= "button" onclick = "makeReservation(${book.id})" class="editbtn">add</button></td>  
                                      </tr>`;

        });

        document.getElementById("allBooksTable").innerHTML = booksHtml;
        //console.log(this.responseText);
      })
  }
  showAllBooks();

  /**
* This method allows the user to make a reservation of a book.
* FOr now the user Id has to be filled in.
* @param userId and bookId.
*/
  function makeReservation(bookId) {
    let newReservation = {
      bookId: bookId,
    };

    // Fetch call
    fetch('http://localhost:8080/book/makereservation', {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": localStorage.getItem('token')
      },
      body: JSON.stringify(newReservation),
    })
      .then((res) => {
        alert("Reservation came through!");
        showReservations();
      });

  }

  /**
* This method displays all reservations from the reservations table.
*/
  function showReservations() {
    fetch('http://localhost:8080/reservations')
      .then(res => res.json())
      .then(data => {
        let reservationsHtml = '';
        data.forEach(reservation => {
          if (reservation.approved == false) {
            reservationsHtml += `
                        <tr>
                        <td>${reservation.id}</td>
                        <td>${reservation.bookTitle}</td>
                        <td>${reservation.nameEmployee}</td>
                        <td><button class ="" type="button" onclick="getIdByReservation(${reservation.id})" data-bs-toggle="modal" data-bs-target="#reservationModal">
                        Approve</button></td>
                        <td><button class ="" type="button" onclick ="deleteReservation(${reservation.id})">Delete</button></td>
                        </tr>
                        `}
        });
        document.getElementById('reservations-data').innerHTML = reservationsHtml
      })
  }

  showReservations();

  /**
* This method shows all borrowd copies in a table.
*/
  function showAllBorrowedCopies() {
    fetch('http://localhost:8080/borrowedcopies/open', {
      headers: {
        "Content-Type": "application/json",
        Authorization: localStorage.getItem("token"),
      },
    })
      .then(res => res.json())
      .then(data => {

        let borrowedcopiesHtml = '';
        data.forEach(borrowedcopy => {
          borrowedcopiesHtml += `
                                      <tr > 
                                          <td >${borrowedcopy.id}</td>
                                          <td >${borrowedcopy.bookCopyId}</td> 
                                              <td>${borrowedcopy.startDate}</td>
                                              <td>${borrowedcopy.endDate}</td> 
                                              <td>${borrowedcopy.userId}</td>       
                                              <td><button type= "button" onclick = "returnBook(${borrowedcopy.id})" class="editbtn">return book</button></td>
                                      </tr>`;

        });

        document.getElementById("borrowedcopytable").innerHTML = borrowedcopiesHtml;
        //console.log(this.responseText);
      })
  }
  showAllBorrowedCopies();

  function getIdByReservation(resId) {
    let result;
    fetch(`http://localhost:8080/reservation/${resId}/getbookiduserid`, {
      method: "GET",
      headers: {
        "Content-Type": "application/json",
        "Authorization": localStorage.getItem('token')
      },
    })
      .then(res => res.json())
      .then(data => {
        result = data;
        let userId = data.userId;
        let bookId = data.bookId;
        console.log(userId);
        console.log(bookId);
        getBookCopies(bookId, userId, resId);
      })

  }

  function getBookCopies(bookId, userId, reservationId) {

    console.log(userId);
    console.log(bookId);

    fetch(`http://localhost:8080/book/${bookId}/availablecopies`, {
      headers: {
        "Content-Type": "application/json",
        "Authorization": localStorage.getItem('token')
      },
    })
      .then((res) => res.json())
      .then(data => {
        let copiesHtml = ``

        data.forEach(copy => {
          copiesHtml += `
                <tr > 
                    <td>${copy.id}</td> 
                    <td> <button class = button onclick = "chooseCopy(${copy.id},${userId},${reservationId})" data-bs-toggle="modal" data-bs-target="#reservationModal"></button></td> 
                </tr>
                `
        })

        document.getElementById("bookcopiesdata").innerHTML = copiesHtml;
      })
  }
  //Approves reservations sends token to backend to check for admin rights.
  function chooseCopy(copyId, userId, reservationId) {

    let newBorrowedCopy = {
      bookCopyId: Number(copyId),
      userId: Number(userId),

    };
    fetch(`http://localhost:8080/reservation/${reservationId}/approve`, {
      method: "PUT",
      headers: {
        "Content-Type": "application/json",
        "Authorization": localStorage.getItem('token')
      },
      body: JSON.stringify(newBorrowedCopy),
    })
      .then((res) => {
        showReservations();

      })
      .catch((error) => {
        alert("Er is iets fouts gegaan");
      });
  }

  function returnBook(borrowedCopyId) {
      // Fetch call
      fetch(`http://localhost:8080/borrowedcopy/${borrowedCopyId}/return`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          Authorization: localStorage.getItem("token"),
        },
      })
        .then((res) => {
          showAllBorrowedCopies();
        })
        .catch((error) => {
          alert("Er is iets fouts gegaan");
        });
    }
</script>

</html>